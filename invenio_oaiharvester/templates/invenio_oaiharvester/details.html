{#
# This file is part of WEKO3.
# Copyright (C) 2017 National Institute of Informatics.
#                                                                                                                                           # WEKO3
is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2 of the
# License, or (at your option) any later version.
#
# WEKO3 is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with WEKO3; if not, write to the
# Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,
# MA 02111-1307, USA.
#}

{% extends 'admin/model/details.html' %}

{% block body %}
{{ super() }}
</br>
<h4>Running logs</h4>
<table id='logs_table' class='table table-striped table-bordered table-hover'>
  <thead>
    <tr>
      <th>#</th>
      <th>{{_('Start Time')}}</th>
      <th>{{_('End Time')}}</th>
      <th>{{_('Status')}}</th>
      <th>{{_('Processed Items')}}</th>
      <th>{{_('Created Items')}}</th>
      <th>{{_('Updated Items')}}</th>
      <th>{{_('Deleted Items')}}</th>
      <th>{{_('Error Items')}}</th>
      <th>{{_('Error Message, Url')}}</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<script>
function _(x) {
    return x
}

function createRow(count, start_time, end_time, status, counter, errmsg, requrl) {
  let table = document.getElementById('logs_table').getElementsByTagName('tbody')[0];
  let row = table.insertRow();
  let result = _('Running')
  if (status == 'Successful') {
      result = _('Successful')
  } else if (status == 'Suspended') {
      result = _('Suspended')
  } else if (status == 'Failed') {
      result = _('Failed')
  } else if (status == 'Cancel') {
      result = _('Cancel')
  } else {
      result = _('Running')
  }
  row.insertCell().innerHTML = count;
  row.insertCell().innerHTML = start_time;
  row.insertCell().innerHTML = end_time;
  row.insertCell().innerHTML = result;
  if (status == 'Running') {
      row.insertCell().innerHTML = '';
      row.insertCell().innerHTML = '';
      row.insertCell().innerHTML = '';
      row.insertCell().innerHTML = '';
      row.insertCell().innerHTML = '';
  } else {
      row.insertCell().innerHTML = counter['processed_items'] ? counter['processed_items'] : 0;
      row.insertCell().innerHTML = counter['created_items'] ? counter['created_items'] : 0;
      row.insertCell().innerHTML = counter['updated_items'] ? counter['updated_items'] : 0;
      row.insertCell().innerHTML = counter['deleted_items'] ? counter['deleted_items'] : 0;
      row.insertCell().innerHTML = counter['error_items'] ? counter['error_items'] : 0;
  }
  if (errmsg) { 
    row.insertCell().innerText = errmsg + '\n' + requrl;
  } else {
    row.insertCell().innerText = '';
  }
}

function processLogs() {
  let logs_url = window.location.href.replace('details', 'get_logs')
  $.getJSON(logs_url, function(data) {
    for (i = 0; i < data.length; ++i) { 
        createRow(
            i + 1, 
            data[i]['start_time'],
            data[i]['end_time'],
            data[i]['status'],
            data[i]['counter'],
            data[i]['errmsg'],
            data[i]['requrl']
        );
    }
  })
}

window.addEventListener('load', processLogs)
</script>
{% endblock %}

